{"title":"Mudong-EV : A multi-threaded network library in C++20","uid":"70154bdd37d99837a150483aa899c737","slug":"Mudong-EV","date":"2023-10-07T14:29:12.000Z","updated":"2023-11-03T16:51:08.570Z","comments":true,"path":"api/articles/Mudong-EV.json","keywords":null,"cover":"https://cdn.statically.io/gh/moonlightleaf/pics@master/项目记录/Mudong-ev封面.39c4ersyvmm0.webp","content":"<h1 id=\"Mudong-EV-A-multi-threaded-network-library-in-C-20\"><a href=\"#Mudong-EV-A-multi-threaded-network-library-in-C-20\" class=\"headerlink\" title=\"Mudong-EV : A multi-threaded network library in C++20\"></a>Mudong-EV : A multi-threaded network library in C++20</h1><h2 id=\"代码仓库\"><a href=\"#代码仓库\" class=\"headerlink\" title=\"代码仓库\"></a>代码仓库</h2><p><a href=\"https://github.com/moonlightleaf/mudong-ev\">https://github.com/moonlightleaf/mudong-ev</a></p>\n<h2 id=\"项目简介\"><a href=\"#项目简介\" class=\"headerlink\" title=\"项目简介\"></a>项目简介</h2><p>mudong-ev是一款基于C++20开发的适用于Linux的事件驱动型多线程网络库，附带有日志、定时器、线程池模块，只依赖STL，无第三方依赖。日志模块使用了C++20标准库中的<strong>format</strong>来进行格式化输出，也是整个项目唯一依赖C++20的模块，其余部分均依赖于C++11实现。参考陈硕的muduo网络库，基于one loop per thread搭配线程池的方式实现multi-reactor架构。</p>\n<h2 id=\"开发环境\"><a href=\"#开发环境\" class=\"headerlink\" title=\"开发环境\"></a>开发环境</h2><table>\n<thead>\n<tr>\n<th align=\"left\">Tool</th>\n<th align=\"center\">Version</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">Ubuntu(WSL2)</td>\n<td align=\"center\">20.04</td>\n</tr>\n<tr>\n<td align=\"left\">GCC</td>\n<td align=\"center\">13.1.0</td>\n</tr>\n<tr>\n<td align=\"left\">Cmake</td>\n<td align=\"center\">3.23.0</td>\n</tr>\n<tr>\n<td align=\"left\">Git</td>\n<td align=\"center\">2.25.1</td>\n</tr>\n</tbody></table>\n<h2 id=\"项目架构\"><a href=\"#项目架构\" class=\"headerlink\" title=\"项目架构\"></a>项目架构</h2><p><img src=\"https://cdn.statically.io/gh/moonlightleaf/pics@master/%E9%A1%B9%E7%9B%AE%E8%AE%B0%E5%BD%95/ev%E6%9E%B6%E6%9E%84.5xw73lsoobs0.webp\"></p>\n<p>mudong-ev的核心架构如上图所示，服务端为一个<strong>TcpServer</strong>实例，该实例中可包含有多个<strong>TcpServerSingle</strong>实例，每个<strong>TcpServerSingle</strong>实例都对应有一个<strong>EventLoop</strong>，运行在一个独立线程中。每个<strong>TcpServerSingle</strong>都包含有独立的<strong>Acceptor</strong>负责监听服务器端口并在连接到来时通过调用<strong>newConnectionCallback</strong>来对连接事件进行处理。该回调函数由<strong>TcpServerSingle</strong>传入<strong>Acceptor</strong>，负责建立连接对象<strong>TcpConnection</strong>。当客户端连接请求到来时，若有多个<strong>Acceptor</strong>监听同一个服务器端口（已开启<strong>SO_REUSEPORT</strong>选项），则由操作系统采用相对公平的方式决定将连接分配给哪个线程，从而实现负载均衡。</p>\n<h2 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h2><p>项目代码仓库中的<strong>examples</strong>文件夹下，有<strong>EchoServer</strong>和<strong>AddOneServer</strong>两个示例，并给出了相应的客户端代码。先运行服务端程序，可以在标准输出流中观察到Log的输出（也可以自定义使得Log输出到指定文件）。之后运行客户端代码，并输入合法的字符串即可收到服务端的返回值。<strong>AddOneServer</strong>操作示例，以两个客户端为例：</p>\n<p>addOne_client 0 :</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># input\n123\n# server return\nConnection handled by tid 27793, \ncalculation handled by tid 27758: 124</code></pre>\n\n<p>addOne_client 1 :</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># input\n234\n# server return\nConnection handled by tid 27800, \ncalculation handled by tid 27759: 235</code></pre>\n\n<p>addOne_server :</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># log\n20231007 13:41:11.610 [27757] [  INFO] create TcpServer 0.0.0.0:9877 - TcpServer.cc:16\n20231007 13:41:11.611 [27757] [  INFO] TcpServer::start() 0.0.0.0:9877 with 32 eventLoop thread(s) - TcpServer.cc:62\n20231007 13:41:16.527 [27757] [  INFO] connection 127.0.0.1:60642 -&gt; 0.0.0.0:9877 is up - AddOneServer.cc:42\n20231007 13:41:19.816 [27757] [ TRACE] connection 127.0.0.1:60642 -&gt; 0.0.0.0:9877 recv 3 byte(s) - AddOneServer.cc:51\n20231007 13:41:23.760 [27757] [  INFO] connection 127.0.0.1:60644 -&gt; 0.0.0.0:9877 is up - AddOneServer.cc:42\n20231007 13:41:26.212 [27757] [ TRACE] connection 127.0.0.1:60644 -&gt; 0.0.0.0:9877 recv 3 byte(s) - AddOneServer.cc:51\n20231007 13:41:35.721 [27757] [  INFO] connection 127.0.0.1:60644 -&gt; 0.0.0.0:9877 is down - AddOneServer.cc:42\n20231007 13:41:38.072 [27757] [  INFO] connection 127.0.0.1:60642 -&gt; 0.0.0.0:9877 is down - AddOneServer.cc:42\n20231007 13:42:11.616 [27757] [  INFO] server quit after 5 second(s)... - AddOneServer.cc:123\n20231007 13:42:12.616 [27757] [  INFO] server quit after 4 second(s)... - AddOneServer.cc:125\n20231007 13:42:13.616 [27757] [  INFO] server quit after 3 second(s)... - AddOneServer.cc:125\n20231007 13:42:14.616 [27757] [  INFO] server quit after 2 second(s)... - AddOneServer.cc:125\n20231007 13:42:15.616 [27757] [  INFO] server quit after 1 second(s)... - AddOneServer.cc:125\n20231007 13:42:16.616 [27757] [  INFO] server quit after 0 second(s)... - AddOneServer.cc:125</code></pre>\n\n<p><strong>AddOneServer</strong>采用multi-reactor接受连接请求，线程池处理计算任务的架构，从客户端得到的返回结果可以看出，两个客户端的连接请求分别由不同的线程接受，两个客户端的计算任务也由线程池中两个不同的线程执行。</p>\n<h2 id=\"测试-性能\"><a href=\"#测试-性能\" class=\"headerlink\" title=\"测试&amp;&amp;性能\"></a>测试&amp;&amp;性能</h2><p>使用<strong>JMeter</strong>对示例中的<strong>AddOneServer</strong>进行压测，TPS可上万。</p>\n<h2 id=\"编译-使用\"><a href=\"#编译-使用\" class=\"headerlink\" title=\"编译&amp;&amp;使用\"></a>编译&amp;&amp;使用</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ git clone https:&#x2F;&#x2F;github.com&#x2F;moonlightleaf&#x2F;mudong-ev.git\n$ cd mudong-ev\n$ mkdir build &amp;&amp; cd build\n$ cmake [-DCMAKE_BUILD_TESTS&#x3D;1] [-DCMAKE_BUILD_EXAMPLES&#x3D;1] ..\n$ make install</code></pre>\n\n<p>可以通过选择是否添加<code>-DCMAKE_BUILD_TESTS=1</code>和<code>-DCMAKE_BUILD_EXAMPLES=1</code>选项，来决定是否要对<code>test</code>和<code>examples</code>目录下的文件进行编译。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://github.com/chenshuo/muduo\">muduo</a>: Event-driven network library for multi-threaded Linux server in C++11</li>\n</ul>\n","feature":true,"text":"Mudong-EV : A multi-threaded network library in C++20代码仓库https://github.com/moon...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/categories/项目记录.json"}],"tags":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/tags/项目记录.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Mudong-EV-A-multi-threaded-network-library-in-C-20\"><span class=\"toc-text\">Mudong-EV : A multi-threaded network library in C++20</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93\"><span class=\"toc-text\">代码仓库</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B\"><span class=\"toc-text\">项目简介</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83\"><span class=\"toc-text\">开发环境</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84\"><span class=\"toc-text\">项目架构</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">使用示例</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95-%E6%80%A7%E8%83%BD\"><span class=\"toc-text\">测试&amp;&amp;性能</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91-%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">编译&amp;&amp;使用</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83\"><span class=\"toc-text\">参考</span></a></li></ol></li></ol>","author":{"name":"月下叶子","slug":"blog-author","avatar":"https://cdn.statically.io/gh/moonlightleaf/pics@master/about/博客头像.1rm6v48dfu1s.jpg","link":"/","description":"日月东升西落，未曾负你我","socials":{"github":"https://github.com/moonlightleaf","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/leaf_in_the_moon","juejin":"","customs":{"leetcode":{"icon":"/svg/leetcode.svg","link":"https://leetcode.cn/u/zhong-v0/"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"Mudong-RPC : A JSON-RPC 2.0 framework implemented in C++20","uid":"abb2fc0e76166506324e12db59bf4947","slug":"Mudong-RPC","date":"2023-11-03T14:02:12.000Z","updated":"2023-11-03T16:58:48.444Z","comments":true,"path":"api/articles/Mudong-RPC.json","keywords":null,"cover":"https://cdn.statically.io/gh/moonlightleaf/pics@master/项目记录/mudong-rpc封面.tc1jyc7z0ts.jpg","text":"Mudong-RPC : A JSON-RPC 2.0 framework implemented in C++20代码仓库https://github.com...","link":"","photos":[],"count_time":{"symbolsCount":"3.5k","symbolsTime":"3 mins."},"categories":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/categories/项目记录.json"}],"tags":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/tags/项目记录.json"}],"author":{"name":"月下叶子","slug":"blog-author","avatar":"https://cdn.statically.io/gh/moonlightleaf/pics@master/about/博客头像.1rm6v48dfu1s.jpg","link":"/","description":"日月东升西落，未曾负你我","socials":{"github":"https://github.com/moonlightleaf","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/leaf_in_the_moon","juejin":"","customs":{"leetcode":{"icon":"/svg/leetcode.svg","link":"https://leetcode.cn/u/zhong-v0/"}}}},"feature":true},"next_post":{"title":"Mudong-JSON : A JSON parser/generator in C++17","uid":"807cb41303b26161ae1be698fadf9a17","slug":"Mudong-JSON","date":"2023-09-28T12:23:12.000Z","updated":"2023-10-07T14:36:58.944Z","comments":true,"path":"api/articles/Mudong-JSON.json","keywords":null,"cover":"https://cdn.statically.io/gh/moonlightleaf/pics@master/随笔配图/ab0ce6cbf0a420572888ae5e6437625.6v9r441cuz40.jpg","text":"Mudong-JSON : A JSON parser&#x2F;generator in C++17 代码仓库https://github.com/moonl...","link":"","photos":[],"count_time":{"symbolsCount":"8k","symbolsTime":"7 mins."},"categories":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/categories/项目记录.json"}],"tags":[{"name":"项目记录","slug":"项目记录","count":3,"path":"api/tags/项目记录.json"}],"author":{"name":"月下叶子","slug":"blog-author","avatar":"https://cdn.statically.io/gh/moonlightleaf/pics@master/about/博客头像.1rm6v48dfu1s.jpg","link":"/","description":"日月东升西落，未曾负你我","socials":{"github":"https://github.com/moonlightleaf","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/leaf_in_the_moon","juejin":"","customs":{"leetcode":{"icon":"/svg/leetcode.svg","link":"https://leetcode.cn/u/zhong-v0/"}}}},"feature":true}}